if(b4w.module_check("game_config"))throw"Failed to register module: game_config";
b4w.register("game_config",function(a,b){a.DEFAULT_POS=new Float32Array([0,-4,0]);a.GEM_OFFSET=new Float32Array([0,1,0]);a.GEM_ROT_OFFSET=new Float32Array([0,0,0,1]);a.GEM_SCALE_OFFSET=.6;a.CL_BLUE=0;a.CL_PURPLE=1;a.CL_RED=2;a.CL_GREEN=3;a.CL_YELLOW=4;a.CL_MULTI=5;a.ROT_SPEED=2;a.CAM_SOFTNESS=.2;a.CAM_OFFSET=new Float32Array([0,6,-16]);a.CHAR_RAY_LENGTH=1.2;a.MAX_CHAR_HP=100;a.CHAR_ATTACK_DIST=2;a.CHAR_ATTACK_STR=35;a.CHAR_ATTACK_ANIM_FRAME=12;a.CH_STILL=0;a.CH_RUN=1;a.CH_ATTACK=2;a.LAVA_DAMAGE_INTERVAL=
.01;a.BONUS_SPAWN_CHANCE=.5;a.BONUS_HP_INCR=30;a.BONUS_SHIELD_TIME=10;a.BONUS_SHIELD_EFFECT=.33;a.BONUS_LAVA_PROT_TIME=15;a.BONUS_LIFETIME=10;a.BONUS_FLASH_SPEED=3;a.SHIELD_FLASH_LENGTH=.9;a.LAVA_FALL_LENGTH=1;a.GOLEM_SPEED=.8;a.GOLEM_ROT_SPEED=1;a.GOLEM_ATTACK_DIST=2;a.GOLEM_ATTACK_STRENGTH=20;a.GOLEM_ATTACK_ANIM_FRAME=30;a.GOLEMS_SPAWN_INTERVAL=3;a.GOLEM_HP=100;a.GS_WALKING=0;a.GS_ATTACKING=1;a.GS_GETTING_OUT=2;a.GS_NONE=3;a.EN_TYPE_GOLEM_LAVA=0;a.EN_TYPE_GOLEM_STONE=1;a.GT_POINT=0;a.GT_CHAR=1;
a.GT_OBELISK=2;a.HP_BONUSES_EMPTIES=["potion_hp","potion_hp.001","potion_hp.002"];a.SHIELD_BONUSES_EMPTIES=["potion_def"];a.LAVA_BONUSES_EMPTIES=["potion_lava"];a.GOLEM_LAVA_DEATH_EMPTY=["golem_lava_death"];a.GOLEM_DEATH_RIG=["golem_death_armature"];a.GOLEM_DEATH_BLOW=["golem_death_blow"];a.GM_SPARE=0;a.GM_CARRIED=1;a.GM_LAYING=2;a.SHUTTER_EMITTER_EMPTY="shutter_glass";a.SHUTTER_EMITTER_NAME="glass_shutter_emitter";a.CHAR_RUN_SPEAKER="character_run";a.CHAR_ATTACK_SPEAKER="sword_miss";a.CHAR_ATTACK_VOICE_SPKS=
["character_voice_atack_01","character_voice_atack_02","character_voice_atack_03"];a.CHAR_HURT_SPKS=["character_voice_hurt_01","character_voice_hurt_02"];a.CHAR_JUMP_SPKS=["character_voice_jump_01","character_voice_jump_02"];a.CHAR_SWORD_SPEAKER="sword_hit";a.CHAR_DEATH_SPEAKER="character_voice_death_01";a.CHAR_LANDING_SPEAKER="character_jump_ends";a.GEM_PICKUP_SPEAKER="gem_pickup";a.GEM_MOUNT_SPEAKER="gem_mount";a.CHAR_HEAL_SPEAKER="bonus_heal";a.CHAR_LAVA_SPEAKER="bonus_lava";a.CHAR_SHIELD_SPEAKER=
"bonus_shield";a.GOLEM_WALK_SPEAKER="golem_walk";a.GOLEM_ATTACK_SPEAKER="golem_atack_miss";a.GOLEM_HIT_SPEAKER="golem_atack_hit";a.GOLEM_GETOUT_SPEAKER="golem_getout";a.GEM_DESTR_SPEAKER="gem_destroy";a.WIN_SPEAKER="final_win";a.BTYPE_HP=0;a.BTYPE_LAVA=1;a.BTYPE_SHIELD=2});if(b4w.module_check("obelisks"))throw"Failed to register module: obelisks";
b4w.register("obelisks",function(a,b){function F(d){switch(d){case "BG":return c.CL_BLUE;case "RG":return c.CL_RED;case "GG":return c.CL_GREEN;case "YG":return c.CL_YELLOW;case "PG":return c.CL_PURPLE}}function A(){for(var c=0;c<r.NUM_OBELISKS;c++){var d=r.ISLES_SHIELD_DUPLI_NAME_LIST;d[2]="island_shield_"+c;d=k.get_object_by_dupli_name_list(d);u.stop(d);u.set_behavior(d,u.AB_FINISH_STOP)}}function h(c,a){var b="obelisk_"+c,g=w[c];if(0<a){var l=r.OBELISKS_GEMS_NAME[c]+"_0"+(g.num_gems+1),b=k.get_object_by_dupli_name(b,
l);k.show_object(b);d.play_def(m);g.gem_health=r.OBELISK_GEM_HEALTH}else if(0>a){l=r.OBELISKS_GEMS_NAME[c]+"_0"+g.num_gems;b=k.get_object_by_dupli_name(b,l);k.hide_object(b);var l=B,p=M;n.get_translation(b,l);n.get_rotation(b,p);e(l,p)}g.num_gems+=a;x(c)}function x(a){if(t(a)&&("volcano"!=r.LEVEL_NAME||!v.island_has_enemies(a))){if("volcano"==r.LEVEL_NAME){var b=r.ISLES_SHIELD_DUPLI_NAME_LIST;b[2]="island_shield_"+a;b=k.get_object_by_dupli_name_list(b);u.play(b);a=k.get_object_by_dupli_name("obelisk_"+
a,r.ISLAND_SPEAKER);d.play_def(a)}a:{for(a=0;a<r.NUM_OBELISKS;a++)if(!t(a)){a=!1;break a}a=!0}a&&(p.disable_controls(),g.disable_environment(),d.clear_playlist(),a=k.get_object_by_name(c.WIN_SPEAKER),d.play_def(a),a=p.get_wrapper(),u.apply(a.rig,"character_idle_01"),u.set_behavior(a.rig,u.AB_CYCLIC),u.play(a.rig),q())}}function e(a,b){var g=k.get_object_by_dupli_name(c.SHUTTER_EMITTER_EMPTY,c.SHUTTER_EMITTER_NAME);n.set_translation_v(g,a);n.set_rotation_v(g,b);k.show_object(g);u.play(g,function(){k.hide_object(g)});
var m=k.get_object_by_dupli_name(c.SHUTTER_EMITTER_EMPTY,c.GEM_DESTR_SPEAKER);d.play_def(m)}function q(){z.show_victory_element(1);y.check_sensor_manifold(null,"UPDATE_VIC_INTERFACE")&&y.remove_sensor_manifold(null,"UPDATE_VIC_INTERFACE");y.create_sensor_manifold(null,"UPDATE_VIC_INTERFACE",y.CT_SHOT,[y.create_timer_sensor(3)],null,function(c,a,d){z.hide_victory_element(1);z.show_replay_button(1)})}function t(c){return w[c].num_gems==r.OBELISK_NUM_GEMS}function C(){for(var c=0;c<r.NUM_OBELISKS;c++){w[c].num_gems=
0;for(var a=1;a<=r.OBELISK_NUM_GEMS;a++){var d=k.get_object_by_dupli_name("obelisk_"+c,r.OBELISKS_GEMS_NAME[c]+"_0"+a);d&&k.hide_object(d)}switch(r.LEVEL_NAME){case "volcano":a=r.ISLES_SHIELD_DUPLI_NAME_LIST;a[2]="island_shield_"+c;a=k.get_object_by_dupli_name_list(a);u.set_frame(a,0);break;case "dungeon":a=k.get_object_by_dupli_name("level_02_enviroment",r.FLOOR_MAGIC_NAME),l.set_nodemat_value(a,["floor_magic_0"+(c+1),"Value"],0)}}}function D(c){for(var a=0;a<r.NUM_OBELISKS;a++)if(w[a].color==c)return a;
return-1}var y=b("controls"),k=b("scenes"),u=b("animation"),d=b("sfx"),n=b("transform"),l=b("objects"),c=b("game_config"),p=b("character"),v=b("enemies"),g=b("environment"),z=b("interface"),r=null,m=null,B=new Float32Array(3),M=new Float32Array(4),w=[];a.init=function(a,d){r=d;var b=p.get_wrapper(),g=function(f,a,d){1==d&&b.gem_slot&&f.num_gems!=r.OBELISK_NUM_GEMS&&(a=b.gem_slot.color,a==f.color||a==c.CL_MULTI)&&(p.remove_gem(),f=D(f.color),h(f,1))};if("volcano"==r.LEVEL_NAME)A();else if("dungeon"==
r.LEVEL_NAME)var e=k.get_object_by_dupli_name("level_02_enviroment",r.FLOOR_MAGIC_NAME),v=function(f,a,c,d){c=d.num_gems/r.OBELISK_NUM_GEMS;var H=d.magic_val;f=y.get_sensor_value(f,a,0);H!=c&&(H<c?d.magic_val+=.25*f:H>c&&(d.magic_val-=.25*f),l.set_nodemat_value(e,["floor_magic_0"+(d.id+1),"Value"],d.magic_val))};for(var t=0;t<r.NUM_OBELISKS;t++){var H=k.get_object_by_dupli_name("obelisk_"+t,"obelisk_collision"),N=r.OBELISKS_GEMS_NAME[t],f={num_gems:0,gem_health:0,color:F(N),id:t,magic_val:0},H=y.create_collision_sensor(H,
"CHARACTER");y.create_sensor_manifold(f,"FILL_OBELISK_"+N,y.CT_TRIGGER,[H],null,g);w.push(f);"dungeon"==r.LEVEL_NAME&&(l.set_nodemat_value(e,["floor_magic_0"+(t+1),"Value"],0),y.create_sensor_manifold(e,"FLOOR_MAGIC"+t,y.CT_CONTINUOUS,[a],null,v,f))}m=k.get_object_by_dupli_name("character",c.GEM_MOUNT_SPEAKER);C()};a.try_to_capture=x;a.is_filled=t;a.num_gems=function(a){return w[a].num_gems};a.damage_obelisk=function(a){--w[a].gem_health||(w[a].gem_health=r.OBELISK_GEM_HEALTH,h(a,-1))};a.reset=C;
a.get_id_by_color=D});if(b4w.module_check("gems"))throw"Failed to register module: gems";
b4w.register("gems",function(a,b){function F(a){if(a.state!=q.GM_SPARE)return!1;if(a.color==q.CL_MULTI)return!0;a=t.get_id_by_color(a.color);return!t.is_filled(a)}var A=b("controls"),h=b("scenes");b("animation");b("sfx");var x=b("transform");b("util");var e=b("constraints");b("vec3");var q=b("game_config"),t=b("obelisks"),C=b("character"),D=[],y=null;a.init=function(a){y=a;a=function(a,c,d,b){1==d&&C.add_gem(b)};for(var b=0;b<y.GEMS_EMPTIES.length;b++){var d=y.GEMS_EMPTIES[b],e=y.GEMS_NAMES[b],l=
h.get_object_by_name(d),d=h.get_object_by_dupli_name(d,e);if(l&&d){switch(h.get_object_name(d)){case "gem_B":var c=q.CL_BLUE;break;case "gem_R":c=q.CL_RED;break;case "gem_G":c=q.CL_GREEN;break;case "gem_Y":c=q.CL_YELLOW;break;case "gem_P":c=q.CL_PURPLE;break;case "gem_M":c=q.CL_MULTI}l={empty:l,color:c,state:q.GM_SPARE};D.push(l);e=A.create_collision_sensor(d,"CHARACTER");A.create_sensor_manifold(d,"PICK_GEM",A.CT_TRIGGER,[e],null,a,l)}}};a.spawn=function(a){for(var b=0,d=0;d<D.length;d++)F(D[d])&&
b++;if(b)for(b=Math.floor(b*Math.random()),d=0;d<D.length;d++){var e=D[d];if(F(e)&&0==b--){x.set_translation_v(e.empty,a);e.state=q.GM_LAYING;break}}};a.reset=function(){for(var a=0;a<D.length;a++){var b=D[a],d=b.empty;e.remove(d);x.set_translation_v(d,q.DEFAULT_POS);b.state=q.GM_SPARE}}});if(b4w.module_check("interface"))throw"Failed to register module: interface";
b4w.register("interface",function(a,b){function F(a,b){function h(k,d,n){k=y-q.global_timeline();0>k?e.remove_sensor_manifold(null,"SHOW_"+a.id):a.style.opacity=1-k/b}b=b||0;a.style.opacity=0;a.style.visibility="visible";var y=q.global_timeline()+b;if(!e.check_sensor_manifold(null,"SHOW_"+a.id)){var k=e.create_elapsed_sensor();e.create_sensor_manifold(null,"SHOW_"+a.id,e.CT_CONTINUOUS,[k],null,h)}}function A(a,b){function h(d,n,l){d=k-q.global_timeline();0>d?(a.style.visibility="hidden",e.remove_sensor_manifold(null,
"HIDE_"+a.id)):a.style.opacity=d/b*y}b=b||0;var y=a.style.opacity,k=q.global_timeline()+b;if(!e.check_sensor_manifold(null,"HIDE_"+a.id)){var u=e.create_elapsed_sensor();e.create_sensor_manifold(null,"HIDE_"+a.id,e.CT_CONTINUOUS,[u],null,h)}}var h=b("character"),x=b("game_config"),e=b("controls"),q=b("main");a.init=function(a){document.getElementById("replay").addEventListener("touchstart",a,!1);document.getElementById("replay").addEventListener("click",a,!1);document.getElementById("life_bar").style.visibility=
"visible"};a.update_hp_bar=function(a){a=h.get_wrapper().hp;var b=document.getElementById("life_bar_green"),e=document.getElementById("life_bar_red"),q=document.getElementById("life_bar_mid"),k=192/x.MAX_CHAR_HP,u=Math.max(a*k,0);a=Math.min((x.MAX_CHAR_HP-a)*k,192);b.style.width=u+"px";e.style.width=a+"px";q.style.left=u+19+"px"};a.setup_touch_controls=function(a,b,h,q,k,u){function d(d){d.preventDefault();d=d.changedTouches;for(var n=0;n<d.length;n++)d[n].identifier==l?(e.set_custom_sensor(b,0),
e.set_custom_sensor(q,0),e.set_custom_sensor(h,0),e.set_custom_sensor(a,0),v.style.visibility="hidden",g.style.visibility="hidden",l=null):d[n].identifier==c?(e.set_custom_sensor(k,0),c=null):d[n].identifier==p&&(e.set_custom_sensor(u,0),p=null)}var n=new Float32Array(2),l,c,p,v=document.getElementById("control_tap"),g=document.getElementById("control_circle"),z=v.clientWidth/2,r=g.clientWidth/2;document.getElementById("canvas3d").addEventListener("touchstart",function(a){a.preventDefault();var c=
window.innerWidth;a=a.changedTouches;for(var d=0;d<a.length;d++){var b=a[d],e=b.clientX,p=b.clientY;if(e>c/2)break;n[0]=e;n[1]=p;l=b.identifier;v.style.visibility="visible";v.style.left=e-z+"px";v.style.top=p-z+"px";g.style.visibility="visible";g.style.left=e-r+"px";g.style.top=p-r+"px"}},!1);document.getElementById("control_jump").addEventListener("touchstart",function(a){a.preventDefault();a=a.changedTouches;for(var d=0;d<a.length;d++){var b=a[d];e.set_custom_sensor(k,1);c=b.identifier}},!1);document.getElementById("control_attack").addEventListener("touchstart",
function(a){a.preventDefault();a=a.changedTouches;for(var d=0;d<a.length;d++){var c=a[d];e.set_custom_sensor(u,1);p=c.identifier}},!1);document.getElementById("canvas3d").addEventListener("touchmove",function(d){d.preventDefault();e.set_custom_sensor(b,0);e.set_custom_sensor(q,0);e.set_custom_sensor(h,0);e.set_custom_sensor(a,0);var c=window.innerWidth;d=d.changedTouches;for(var g=0;g<d.length;g++){var l=d[g],p=l.clientX,l=l.clientY;if(p>c/2)break;v.style.left=p-z+"px";v.style.top=l-z+"px";var p=
p-n[0],l=l-n[1],k=Math.sqrt(p*p+l*l);if(16>k)break;p/=k;l=-l/k;p>Math.cos(3*Math.PI/8)?e.set_custom_sensor(a,1):p<-Math.cos(3*Math.PI/8)&&e.set_custom_sensor(h,1);l>Math.sin(Math.PI/8)?e.set_custom_sensor(b,1):l<-Math.sin(Math.PI/8)&&e.set_custom_sensor(q,1)}},!1);document.getElementById("canvas3d").addEventListener("touchend",d,!1);document.getElementById("controls").addEventListener("touchend",d,!1);document.getElementById("control_jump").style.visibility="visible";document.getElementById("control_attack").style.visibility=
"visible"};a.show_replay_button=function(a){var b=document.getElementById("replay");F(b,a)};a.hide_replay_button=function(a){var b=document.getElementById("replay");A(b,a)};a.show_victory_element=function(a){var b=document.getElementById("victory");F(b,a)};a.hide_victory_element=function(a){var b=document.getElementById("victory");A(b,a)}});if(b4w.module_check("bonuses"))throw"Failed to register module: bonuses";
b4w.register("bonuses",function(a,b){function F(a){function c(a,c,b,g){if(1==b)switch(x.set_translation_v(g.empty,h.DEFAULT_POS),g.type){case h.BTYPE_HP:C.apply_hp_potion();t.play_def(y);break;case h.BTYPE_LAVA:n<=h.LAVA_FALL_LENGTH&&C.apply_lava_protect();n=h.BONUS_LAVA_PROT_TIME;t.play_def(k);break;case h.BTYPE_SHIELD:d<=h.SHIELD_FLASH_LENGTH&&C.apply_shield(),d=h.BONUS_SHIELD_TIME,t.play_def(u)}}function b(a,d,c,g){a=e.get_sensor_value(a,d,0);g.lifetime-=a;0<g.lifetime?(a=g.lifetime,4<a||(g=g.body,
a*=h.BONUS_FLASH_SPEED,.5<(1>a?a:a%Math.floor(a))?q.hide_object(g):q.show_object(g))):(x.set_translation_v(g.empty,h.DEFAULT_POS),g.is_spawned=!1)}for(var v=0;v<D.length;v++){var g=D[v],z=g.body,r=e.create_collision_sensor(z,"CHARACTER");e.create_sensor_manifold(z,"BONUS",e.CT_TRIGGER,[r],null,c,g);e.create_sensor_manifold(z,"BONUS_LIFETIME",e.CT_CONTINUOUS,[a],null,b,g)}}function A(a,d,b){for(var e=0;e<a.length;e++){var g;var k=a[e];g=d;var n=b,m=q.get_object_by_name(k),k=q.get_object_by_dupli_name(k,
n);g=m&&k?{empty:m,body:k,lifetime:h.BONUS_LIFETIME,type:g,is_spawned:!1}:null;g&&D.push(g)}}var h=b("game_config"),x=b("transform"),e=b("controls"),q=b("scenes"),t=b("sfx"),C=b("character"),D=[],y=null,k=null,u=null,d=0,n=0;new Float32Array(3);a.init=function(a,b){y=q.get_object_by_dupli_name("character",h.CHAR_HEAL_SPEAKER);k=q.get_object_by_dupli_name("character",h.CHAR_LAVA_SPEAKER);u=q.get_object_by_dupli_name("character",h.CHAR_SHIELD_SPEAKER);A(h.HP_BONUSES_EMPTIES,h.BTYPE_HP,"potion_HP");
A(h.LAVA_BONUSES_EMPTIES,h.BTYPE_LAVA,"potion_LAVA");A(h.SHIELD_BONUSES_EMPTIES,h.BTYPE_SHIELD,"potion_SHIELD");F(a);e.create_sensor_manifold(null,"BONUS_TIMER",e.CT_CONTINUOUS,[a],null,function(a,b){var c=e.get_sensor_value(a,b,0);0<d&&(d-c<h.SHIELD_FLASH_LENGTH&&C.remove_shield(),d-=c);0<n&&(n-c<h.LAVA_FALL_LENGTH&&C.remove_lava_protect(),n-=c)})};a.spawn=function(a){for(var d=Math.floor(3*Math.random()),b=0;b<D.length;b++){var e=D[b];if(!e.is_spawned&&e.type==d){a[1]+=.05;x.set_translation_v(e.empty,
a);e.lifetime=h.BONUS_LIFETIME;e.is_spawned=!0;q.show_object(e.body);break}}};a.reset=function(){function a(d){for(var b=0;b<d.length;b++){var e=q.get_object_by_name(d[b]);x.set_translation_v(e,h.DEFAULT_POS)}}a(h.HP_BONUSES_EMPTIES);a(h.SHIELD_BONUSES_EMPTIES);a(h.LAVA_BONUSES_EMPTIES)};a.set_shield_time=function(a){d=a};a.set_lava_protect_time=function(a){n=a};a.lava_protect_time_left=function(){return n};a.shield_time_left=function(){return d}});if(b4w.module_check("enemies"))throw"Failed to register module: enemies";
b4w.register("enemies",function(a,b){function F(a,d){var f=a.empty.name;a.walk_speaker=u.get_object_by_dupli_name(f,g.GOLEM_WALK_SPEAKER);a.attack_speaker=u.get_object_by_dupli_name(f,g.GOLEM_ATTACK_SPEAKER);a.hit_speaker=u.get_object_by_dupli_name(f,g.GOLEM_HIT_SPEAKER);a.getout_speaker=u.get_object_by_dupli_name(f,g.GOLEM_GETOUT_SPEAKER);switch(d){case "lava":a.type=g.EN_TYPE_GOLEM_LAVA;break;case "stone":a.type=g.EN_TYPE_GOLEM_STONE}a.death_anim="golem_death";a.walk_anim="golem_walk";a.atack_anim=
["golem_atack_01","golem_atack_02","golem_atack_03"];a.getout_anim="golem_"+d+"_getout";a.death_empty_name="golem_"+d+"_death";f=l.get_object_bounding_box(a.body);a.height=f.max_y-f.min_y}function A(a,b,f){if(0>=a.hp){b=a.empty;f=u.get_object_by_name(a.death_empty_name);var c=u.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_RIG),p=u.get_object_by_dupli_name(a.death_empty_name,g.GOLEM_DEATH_BLOW),h=E,q=K;l.get_translation(b,h);l.get_rotation(b,q);l.set_translation_v(f,h);l.set_rotation_v(f,
q);d.apply(c,a.death_anim);d.set_behavior(c,d.AB_FINISH_STOP);d.play(c);d.play(p);n.stop(a.walk_speaker);l.set_translation_v(b,g.DEFAULT_POS);M.spawn(h);"volcano"==w.LEVEL_NAME&&(b=a.island_id,a.island_id=-1,m.try_to_capture(b));a.hp=100;C(a,g.GS_NONE)}else switch(f=k.get_sensor_value(a,b,1),a.dist_to_ground=10*f-a.height/2,a.state){case g.GS_ATTACKING:!a.attack_done&&d.get_frame(a.rig)>=g.GOLEM_ATTACK_ANIM_FRAME&&(a.last_target==g.GT_CHAR?r.check_attack(a.attack_point,z.get_wrapper().phys_body,g.GOLEM_ATTACK_DIST)&&
(b=g.GOLEM_ATTACK_STRENGTH,0<B.shield_time_left()&&(b*=g.BONUS_SHIELD_EFFECT),z.change_hp(-b),n.play_def(a.hit_speaker)):a.last_target==g.GT_OBELISK&&(b=a.island_id,m.num_gems(b)&&m.damage_obelisk(b),n.play_def(a.hit_speaker)),a.attack_done=!0);break;case g.GS_WALKING:b=k.get_sensor_value(a,b,0),f=z.get_wrapper(),"volcano"==w.LEVEL_NAME?(c=a.island_id,f.island==c&&0<f.hp?(x(a,f.phys_body,b),a.last_target=g.GT_CHAR):m.num_gems(c)?(f=u.get_object_by_dupli_name("obelisk_"+c,"obelisk"),x(a,f,b),a.last_target=
g.GT_OBELISK):e(a,b)):"dungeon"==w.LEVEL_NAME?0<f.hp&&r.check_visibility(a,f)?(x(a,f.phys_body,b),a.speed=2*g.GOLEM_SPEED,d.set_speed(a.rig,2),a.last_target=g.GT_CHAR):e(a,b):e(a,b)}}function h(a){for(var b=[],f=[],d=0;d<w.GOLEM_SPAWN_POINTS.length;d++){var c=u.get_object_by_name(w.GOLEM_SPAWN_POINTS[d]),e=l.get_translation(c),c=l.get_rotation(c);b.push(e);f.push(c)}k.create_sensor_manifold(null,"GOLEMS_SPAWN",k.CT_CONTINUOUS,[a],null,function(a,d){var c;a:{for(c=0;c<G.length;c++){var e=G[c];if(e.state==
g.GS_NONE){c=e;break a}}c=null}if(c&&(e=k.get_sensor_value(a,d,0),I-=e,0>=I)){I=g.GOLEMS_SPAWN_INTERVAL;if("volcano"==w.LEVEL_NAME){if(e=D(),null==e)return}else e=0;var H=e,h=c.empty,e="volcano"==w.LEVEL_NAME?b.length/w.NUM_OBELISKS:b.length,m=Math.floor(Math.random()*e),m=e*H+m,e=b[m],m=f[m];l.set_translation_v(h,e);l.set_rotation_v(h,m);C(c,g.GS_GETTING_OUT);n.play_def(c.getout_speaker);if("volcano"==w.LEVEL_NAME)c.island_id=H,p.copy(e,c.dest_pos);else{for(var H=w.GOLEM_PATROL_POINTS,h=H.length,
m=c.dest_pos,q=1E3,U=-1,V=0;V<h;V++){var W=u.get_object_by_name(H[V]);l.get_translation(W,L);W=p.distance(L,e);W<q&&(q=W,U=V,p.copy(L,m),m[1]=e[1])}c.dest_point=U}}})}function x(a,b,f){var c=E,e=L;l.get_translation(a.empty,c);l.get_translation(b,e);e[1]=c[1];p.copy(e,a.dest_pos);b=p.distance(c,e);c=q(a,f);b>=g.GOLEM_ATTACK_DIST?t(a,f):c<.05*Math.PI&&(f=a.empty,b=a.attack_point,c=E,e=L,d.set_speed(a.rig,2),a.attack_done=!1,C(a,g.GS_ATTACKING),l.get_translation(f,c),p.scaleAndAdd(c,e,g.GOLEM_ATTACK_DIST,
b),b[1]+=a.height/2,n.is_play(a.walk_speaker)&&n.stop(a.walk_speaker),n.play_def(a.attack_speaker))}function e(a,b){a.speed=g.GOLEM_SPEED;d.set_speed(a.rig,1);var c=a.dest_pos,e=E;l.get_translation(a.empty,e);var k=e[1];e[1]=c[1];c=p.distance(e,c);e[1]=k;if(!(.05<c&&a.last_target==g.GT_POINT))if(a.last_target=g.GT_POINT,"volcano"==w.LEVEL_NAME)b:{for(var k=a.dest_pos,c=a.dest_point,m=a.island_id,h=w.GOLEM_PATROL_POINTS,n=h.length/w.NUM_OBELISKS,v=Math.random(),z=Math.floor(n*v),r=0,v=0;v<n;v++)if(v!=
c&&r++==z){m=u.get_object_by_name(h[n*m+v]);l.get_translation(m,k);k[1]=e[1];a.prev_dest=c;a.dest_point=v;break b}a.dest_point=-1}else k=a.dest_pos,c=a.dest_point,m=w.GOLEM_PATROL_POINTS,h=w.GOLEM_PATROL_MAP[c],n=h.length-1,v=Math.random(),h=h[Math.floor(n*v)],m=u.get_object_by_name(m[h]),l.get_translation(m,k),k[1]=e[1],a.prev_dest=c,a.dest_point=h;q(a,b);t(a,b)}function q(a,b){var d=a.empty,e=a.dest_pos,k=E,m=L,h=J,n=K,q=O;l.get_translation(d,k);l.get_rotation(d,n);p.transformQuat(c.AXIS_Z,n,m);
p.subtract(e,k,h);h[1]=0;p.normalize(h,h);v.rotationTo(m,h,q);v.multiply(q,n,q);e=p.dot(m,h);e=Math.acos(1<e?1:-1>e?-1:e);k=Math.abs(e)/Math.PI;v.slerp(n,q,Math.min(b/k*g.GOLEM_ROT_SPEED,1),q);l.set_rotation_v(d,q);return e}function t(a,b){var d=E,e=L,g=K,k=a.empty,h=a.walk_speaker;l.get_rotation(k,g);l.get_translation(k,d);p.transformQuat(c.AXIS_Z,g,e);p.scaleAndAdd(d,e,a.speed*b,d);e=b/3;d[1]-=a.dist_to_ground>e?e:a.dist_to_ground<-e?-e:e;l.set_translation_v(k,d);n.is_play(h)||(n.play_def(h),n.cyclic(h,
!0))}function C(a,b){var c=a.rig;switch(b){case g.GS_WALKING:d.apply(c,a.walk_anim);d.set_behavior(c,d.AB_CYCLIC);d.play(c);break;case g.GS_ATTACKING:var e=Math.floor(a.atack_anim.length*Math.random());d.apply(c,a.atack_anim[e]);d.play(c,function(){a.state!=g.GS_NONE&&C(a,g.GS_WALKING)});break;case g.GS_GETTING_OUT:d.apply(c,a.getout_anim),d.play(c,function(){a.state!=g.GS_NONE&&C(a,g.GS_WALKING)})}a.state=b}function D(){for(var a=w.NUM_OBELISKS,b=0;b<G.length;b++)y(b)||a--;if(0==a)return null;for(var a=
Math.floor(Math.random()*a),c=0,b=0;b<w.NUM_OBELISKS;b++)if(y(b)&&c++==a)return b;return null}function y(a){if(m.is_filled(a))return!1;for(var b=0;b<G.length;b++)if(G[b].island_id==a)return!1;return!0}var k=b("controls"),u=b("scenes"),d=b("animation"),n=b("sfx"),l=b("transform"),c=b("util"),p=b("vec3"),v=b("quat"),g=b("game_config"),z=b("character"),r=b("combat"),m=b("obelisks"),B=b("bonuses"),M=b("gems"),w=null,G=[],E=new Float32Array(3),L=new Float32Array(3),J=new Float32Array(3),K=new Float32Array(4),
O=new Float32Array(4),I=0;a.init=function(a,b){w=b;I=g.GOLEMS_SPAWN_INTERVAL;for(var c=0;c<w.GOLEMS_EMPTIES.length;c++){var d=w.GOLEMS_EMPTIES[c],e=u.get_object_by_name(d),p=u.get_object_by_dupli_name(d,"golem_collider"),d=u.get_object_by_dupli_name(d,"golem_armature");p&&d&&e&&(e={body:p,rig:d,empty:e,height:0,type:g.EN_TYPE_GOLEM_LAVA,view_distance:10,walk_speaker:null,attack_speaker:null,hit_speaker:null,getout_speaker:null,death_empty_name:null,hp:g.GOLEM_HP,speed:g.GOLEM_SPEED,island_id:-1,dest_point:-1,
prev_dest:-1,dest_pos:new Float32Array(3),dist_to_ground:0,last_target:g.GT_POINT,state:g.GS_NONE,attack_point:new Float32Array(3),attack_done:!1},d=-1!=p.name.indexOf("lava")?"lava":"stone",F(e,d),p=k.create_ray_sensor(p,[0,0,0],[0,-10,0],"GROUND",!1,!1,!0),k.create_sensor_manifold(e,"GOLEM",k.CT_CONTINUOUS,[a,p],function(a){return!0},A),G.push(e),r.append_enemy(e))}h(a)};a.reset=function(){I=g.GOLEMS_SPAWN_INTERVAL;for(var a=0;a<G.length;a++){var b=G[a];b.island_id=-1;C(b,g.GS_NONE);l.set_translation_v(b.empty,
g.DEFAULT_POS);n.stop(b.walk_speaker)}};a.island_has_enemies=function(a){for(var b=0;b<G.length;b++)if(G[b].island_id==a)return!0;return!1}});if(b4w.module_check("combat"))throw"Failed to register module: combat";
b4w.register("combat",function(a,b){function F(a,b,q){var k=e;A.get_translation(b,k);return h.distance(k,a)<q?!0:!1}var A=b("transform"),h=b("vec3"),x=b("game_config"),e=new Float32Array(3),q=new Float32Array(3),t=[];a.append_enemy=function(a){t.push(a)};a.process_attack_on_enemies=function(a,b){for(var e=0;e<t.length;e++){var k=t[e];if(!(0>=k.hp||k.state==x.GS_NONE)&&F(a,k.empty,b))return k.hp-=x.CHAR_ATTACK_STR,!0}return!1};a.check_attack=F;a.check_visibility=function(a,b){var t=A.get_translation(a.body,
e),k=A.get_translation(b.body,q);return h.distance(t,k)>a.view_distance?!1:!0}});if(b4w.module_check("character"))throw"Failed to register module: character";
b4w.register("character",function(a,b){function F(){for(var a=function(a,b,c){f.island=1==c?parseInt(b[b.length-1]):-1},b=0;b<G.NUM_OBELISKS;b++){var c=d.create_collision_sensor(f.picker,"ISLAND"+b);d.create_sensor_manifold(f.picker,"ISLE_COLL"+b,d.CT_TRIGGER,[c],null,a)}}function A(a){var b=d.create_ray_sensor(f.phys_body,[0,0,0],[0,-m.CHAR_RAY_LENGTH,0],"GROUND",!0),c=d.create_ray_sensor(f.phys_body,[0,0,0],[0,-m.CHAR_RAY_LENGTH,0],"LAVA",!0),e=d.create_ray_sensor(f.phys_body,[0,0,0],[0,-m.CHAR_RAY_LENGTH,
0],"COMMON",!0);d.create_sensor_manifold(f.phys_body,"GROUND SENS",d.CT_TRIGGER,[b,c,e],function(a){return a[0]||a[1]||a[2]},function(b,c,f){d.set_custom_sensor(a,1==f?1:0)})}function h(a,b,e){function g(a,b,e){if(f.state==m.CH_ATTACK)l.set_character_move_dir(a,0,0);else{var k=d.get_sensor_value(a,b,6);if(1==e){switch(b){case "FORWARD":var h=1;break;case "BACKWARD":h=-1}f.state==m.CH_STILL&&k&&(c.apply(f.rig,"character_run"),c.play(f.rig),c.set_behavior(f.rig,c.AB_CYCLIC));f.state=m.CH_RUN}else h=
0,f.state==m.CH_RUN&&k&&(c.apply(f.rig,"character_idle_01"),c.set_behavior(f.rig,c.AB_CYCLIC),c.play(f.rig)),f.state=m.CH_STILL;h&&k?p.is_play(E)||p.play_def(E):p.is_play(E)&&p.stop(E);l.set_character_move_dir(a,h,0)}}var k=d.create_keyboard_sensor(d.KEY_W),h=d.create_keyboard_sensor(d.KEY_S),U=d.create_keyboard_sensor(d.KEY_UP),n=d.create_keyboard_sensor(d.KEY_DOWN);a=[k,U,a,h,n,b,e];d.create_sensor_manifold(f.phys_body,"FORWARD",d.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},g);d.create_sensor_manifold(f.phys_body,
"BACKWARD",d.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},g);c.apply(f.rig,"character_idle_01");c.play(f.rig);c.set_behavior(f.rig,c.AB_CYCLIC);f.body&&(c.apply(f.body,"HEAL_run"),c.apply(f.body,"LAVA_grow",c.SLOT_1),c.apply(f.body,"SHIELD_grow",c.SLOT_2));f.shield_sphere&&c.apply(f.shield_sphere,"SHIELD_GLOW_grow");p.stop(E)}function x(a,b,c){function e(a,b,c){if(f.state!=m.CH_ATTACK){var g=d.get_sensor_value(a,"LEFT",6);if(1==c)switch(b){case "LEFT":l.character_rotation_inc(a,g*m.ROT_SPEED,
0);break;case "RIGHT":l.character_rotation_inc(a,-g*m.ROT_SPEED,0)}}}var g=d.create_keyboard_sensor(d.KEY_A),k=d.create_keyboard_sensor(d.KEY_D),h=d.create_keyboard_sensor(d.KEY_LEFT),p=d.create_keyboard_sensor(d.KEY_RIGHT);a=[g,h,b,k,p,a,c];d.create_sensor_manifold(f.phys_body,"LEFT",d.CT_CONTINUOUS,a,function(a){return a[0]||a[1]||a[2]},e);d.create_sensor_manifold(f.phys_body,"RIGHT",d.CT_CONTINUOUS,a,function(a){return a[3]||a[4]||a[5]},e)}function e(a,b){var e=d.create_keyboard_sensor(d.KEY_SPACE);
d.create_sensor_manifold(f.phys_body,"JUMP",d.CT_TRIGGER,[e,a,b],function(a){return a[0]||a[1]},function(a,b,e){1==e&&f.state!=m.CH_ATTACK&&(l.character_jump(a),d.get_sensor_value(a,b,2)&&(b=Math.floor(2*Math.random()),p.play_def(I[b]),c.apply(f.rig,"character_jump"),c.set_behavior(f.rig,c.AB_FINISH_STOP),c.play(f.rig)))});d.create_sensor_manifold(f.phys_body,"LANDING",d.CT_TRIGGER,[b],null,function(a,b,d){1==d&&(p.play_def(K),f.state==m.CH_STILL?(c.apply(f.rig,"character_idle_01"),c.set_behavior(f.rig,
c.AB_CYCLIC),c.play(f.rig)):f.state==m.CH_RUN&&(c.apply(f.rig,"character_run"),c.set_behavior(f.rig,c.AB_CYCLIC),c.play(f.rig)))})}function q(a,b){function e(a){c.apply(f.rig,"character_idle_01");c.set_behavior(f.rig,c.AB_CYCLIC);c.play(f.rig);f.state=m.CH_STILL}var k=d.create_keyboard_sensor(d.KEY_ENTER),h=!1;d.create_sensor_manifold(f.phys_body,"ATTACK",d.CT_TRIGGER,[k,a],function(a){return a[0]||a[1]},function(a,b,d){1==d&&f.state!=m.CH_ATTACK&&(f.state=m.CH_ATTACK,a=Math.floor(3*Math.random())+
1,c.apply(f.rig,"character_atack_0"+a),c.set_behavior(f.rig,c.AB_FINISH_STOP),c.play(f.rig,e),l.set_character_move_dir(f.phys_body,0,0),h=!1,p.is_play(E)&&p.stop(E),p.play_def(L),a=Math.floor(3*Math.random()),p.play_def(H[a]))});d.create_sensor_manifold(f.phys_body,"DAMAGE_GOLEMS",d.CT_CONTINUOUS,[b],null,function(a,b,d){if(f.state==m.CH_ATTACK&&!h&&c.get_frame(f.rig)>=m.CHAR_ATTACK_ANIM_FRAME){a=R;b=S;d=T;var e=Q,k=m.CHAR_ATTACK_DIST;v.get_translation(f.phys_body,a);v.get_rotation(f.phys_body,e);
z.transformQuat(g.AXIS_Z,e,b);z.scaleAndAdd(a,b,k,d);B.process_attack_on_enemies(d,k)&&(p.play_def(J),c.play(f.hitsparks));h=!0}})}function t(){d.check_sensor_manifolds(f.phys_body)&&d.remove_sensor_manifold(f.phys_body);l.set_character_move_dir(f.phys_body,0,0);p.stop(E)}function C(){c.apply(f.body,"LAVA_fall",c.SLOT_1);c.set_behavior(f.body,c.AB_FINISH_STOP,c.SLOT_1);c.play(f.body,null,c.SLOT_1);w.set_lava_protect_time(0)}function D(){c.apply(f.body,"SHIELD_flash",c.SLOT_2);c.set_behavior(f.body,
c.AB_FINISH_STOP,c.SLOT_2);c.play(f.body,null,c.SLOT_2);c.apply(f.shield_sphere,"SHIELD_GLOW_fall");c.set_behavior(f.shield_sphere,c.AB_FINISH_STOP);c.play(f.shield_sphere);w.set_shield_time(0)}function y(a){if(!(0>=f.hp)){var b=u.global_timeline();if(0>a&&P<b-.5){var d=Math.floor(2*Math.random());p.play_def(N[d]);P=b}f.hp+=a;f.hp=Math.min(f.hp,m.MAX_CHAR_HP);0>=f.hp&&(t(),G.MUSIC_SPEAKERS&&(p.clear_playlist(),a=n.get_object_by_dupli_name("enviroment",G.MUSIC_INTRO_SPEAKER),p.stop(a),a=n.get_object_by_dupli_name("enviroment",
G.MUSIC_END_SPEAKER),p.play_def(a)),a=n.get_object_by_dupli_name("character",m.CHAR_DEATH_SPEAKER),p.play_def(a),c.apply(f.rig,"character_death"),c.set_behavior(f.rig,c.AB_FINISH_STOP),c.play(f.rig),M.show_replay_button(1),f.gem_slot&&k(),0<w.shield_time_left&&D(),0<w.lava_protect_time_left&&C());M.update_hp_bar()}}function k(){var a=f.gem_slot.empty;r.remove(a);v.set_translation_v(a,m.DEFAULT_POS);v.set_scale(a,1);f.gem_slot.state=m.GM_SPARE;f.gem_slot=null}var u=b("main"),d=b("controls"),n=b("scenes"),
l=b("physics"),c=b("animation"),p=b("sfx"),v=b("transform"),g=b("util"),z=b("vec3"),r=b("constraints"),m=b("game_config"),B=b("combat"),M=b("interface"),w=b("bonuses");b("environment");var G=null,E=null,L=null,J=null,K=null,O=null,I=[],H=[],N=[],f=null,P=-100,R=new Float32Array(3),S=new Float32Array(3),T=new Float32Array(3),Q=new Float32Array(4);a.init_wrapper=function(a,b){G=a;f={phys_body:n.get_first_character(),rig:n.get_object_by_dupli_name("character","character_rig"),body:n.get_object_by_dupli_name("character",
"character_body_"+b),picker:n.get_object_by_dupli_name("character","character_picker"),shield_sphere:n.get_object_by_dupli_name("character","shield_sphere"),hitsparks:n.get_object_by_dupli_name("character","sword_hitsparks_emitter"),hp:m.MAX_CHAR_HP,state:m.CH_STILL,gem_slot:null,island:-1};c.apply_def(f.hitsparks);c.set_behavior(f.hitsparks,c.AB_FINISH_RESET)};a.setup_controls=function(a){E=n.get_object_by_dupli_name("character",m.CHAR_RUN_SPEAKER);L=n.get_object_by_dupli_name("character",m.CHAR_ATTACK_SPEAKER);
J=n.get_object_by_dupli_name("character",m.CHAR_SWORD_SPEAKER);K=n.get_object_by_dupli_name("character",m.CHAR_LANDING_SPEAKER);O=n.get_object_by_dupli_name("character",m.GEM_PICKUP_SPEAKER);for(var b=0;b<m.CHAR_JUMP_SPKS.length;b++){var c=n.get_object_by_dupli_name("character",m.CHAR_JUMP_SPKS[b]);I.push(c)}for(b=0;b<m.CHAR_ATTACK_VOICE_SPKS.length;b++)c=n.get_object_by_dupli_name("character",m.CHAR_ATTACK_VOICE_SPKS[b]),H.push(c);for(b=0;b<m.CHAR_HURT_SPKS.length;b++)c=n.get_object_by_dupli_name("character",
m.CHAR_HURT_SPKS[b]),N.push(c);"volcano"==G.LEVEL_NAME&&F();var b=d.create_custom_sensor(0),c=d.create_custom_sensor(0),f=d.create_custom_sensor(0),g=d.create_custom_sensor(0),k=d.create_custom_sensor(0),p=d.create_custom_sensor(0),l=d.create_custom_sensor(0);A(l);var v;v=navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||
navigator.userAgent.match(/Windows Phone/i)?!0:!1;v&&M.setup_touch_controls(b,f,c,g,k,p);h(f,g,l);x(b,c,a);e(k,l);q(p,a)};a.disable_controls=t;a.reset=function(){f.state=m.CH_STILL;f.hp=m.MAX_CHAR_HP;f.island=-1;v.get_rotation(f.phys_body,Q);l.set_transform(f.phys_body,G.CHAR_DEF_POS,Q);l.set_character_move_dir(f.phys_body,0,0)};a.apply_hp_potion=function(){y(m.BONUS_HP_INCR);c.play(f.body)};a.apply_lava_protect=function(){c.apply(f.body,"LAVA_grow",c.SLOT_1);c.set_behavior(f.body,c.AB_FINISH_STOP,
c.SLOT_1);c.play(f.body,null,c.SLOT_1)};a.remove_lava_protect=C;a.apply_shield=function(){c.apply(f.body,"SHIELD_grow",c.SLOT_2);c.set_behavior(f.body,c.AB_FINISH_STOP,c.SLOT_2);c.play(f.body,null,c.SLOT_2);c.apply(f.shield_sphere,"SHIELD_GLOW_grow");c.set_behavior(f.shield_sphere,c.AB_FINISH_STOP);c.play(f.shield_sphere)};a.remove_shield=D;a.change_hp=y;a.add_gem=function(a){var b=a.empty;if(f.gem_slot){if(f.gem_slot==a)return;k()}b=a.empty;r.append_stiff(b,f.phys_body,m.GEM_OFFSET,m.GEM_ROT_OFFSET,
m.GEM_SCALE_OFFSET);a.state=m.GM_CARRIED;f.gem_slot=a;p.play_def(O)};a.remove_gem=k;a.get_wrapper=function(){return f}});if(b4w.module_check("environment"))throw"Failed to register module: environment";
b4w.register("environment",function(a,b){function F(a,b){function h(a,b,c){b=e.get_sensor_value(a,b,0);c=q.get_object_name(a);n[c]+=b;n[c]<=d.ROCK_FALL_DELAY||(c=l,t.get_translation(a,c),c[1]-=d.ROCK_SPEED*b,t.set_translation_v(a,c))}function g(a,b,c,g){var h=l,p=g[0];g=g[1];c=y.get_wrapper();t.get_translation(c.phys_body,h);c=e.get_sensor_value(a,b,0)?0:1;b=e.get_sensor_payload(a,b,c).coll_pos;h=C.distance(h,b);t.set_translation_v(p,b);x.set_frame(p,0,x.SLOT_ALL);x.play(p,null,x.SLOT_ALL);A(a);h<
d.ROCK_DAMAGE_RADIUS&&(p=-d.ROCK_DAMAGE,0<u.shield_time_left()&&(p*=k.BONUS_SHIELD_EFFECT),y.change_hp(p));a=q.get_object_name(a);n[a]=0;(a=Math.random()<k.BONUS_SPAWN_CHANCE)&&0==c&&u.spawn(b);D.play_def(g)}function z(a,b,c,g){c=e.get_sensor_value(a,b,0)?0:1;b=e.get_sensor_payload(a,b,c).hit_fract;c=l;var k=q.get_object_name(a);n[k]<=d.ROCK_FALL_DELAY&&(t.get_translation(a,c),c[1]-=b*d.ROCK_RAY_LENGTH-.01,t.set_translation_v(g,c));t.set_scale(g,1-b)}for(var r=0;r<d.ROCK_EMPTIES.length;r++)for(var m=
d.ROCK_EMPTIES[r],B=0;B<d.ROCK_NAMES.length;B++){var F=d.ROCK_NAMES[B],w=d.BURST_EMITTER_NAMES[B],G=d.MARK_NAMES[B],E=q.get_object_by_dupli_name(m,F),w=q.get_object_by_dupli_name(m,w),G=q.get_object_by_dupli_name(m,G),L=q.get_object_by_dupli_name(m,d.ROCK_HIT_SPEAKERS[B]),J=e.create_collision_sensor(E,"LAVA",!0),K=e.create_collision_sensor(E,"GROUND",!0),O=e.create_ray_sensor(E,[0,0,0],[0,-d.ROCK_RAY_LENGTH,0],"GROUND",!0),I=e.create_ray_sensor(E,[0,0,0],[0,-d.ROCK_RAY_LENGTH,0],"LAVA",!0);e.create_sensor_manifold(E,
"ROCK_FALL",e.CT_CONTINUOUS,[a],null,h);e.create_sensor_manifold(E,"ROCK_CRASH",e.CT_SHOT,[K,J],function(a){return a[0]||a[1]},g,[w,L]);e.create_sensor_manifold(E,"MARK_POS",e.CT_CONTINUOUS,[O,I],function(a){return a[0]||a[1]},z,G);A(E);n[F]=0}}function A(a){var b=l;b[0]=32*Math.random()-16;b[1]=16*Math.random()+8;b[2]=32*Math.random()-16;t.set_translation_v(a,b)}function h(a){var b=0,h=y.get_wrapper(),g=e.create_ray_sensor(h.phys_body,[0,0,0],[0,-k.CHAR_RAY_LENGTH,0],"LAVA",!0);e.create_sensor_manifold(h.phys_body,
"LAVA_COLLISION",e.CT_CONTINUOUS,[g,a],function(a){return a[0]},function(a,c,d,g){1==d?(a=e.get_sensor_value(a,c,1),b+=a,b>=k.LAVA_DAMAGE_INTERVAL&&(a=a<k.LAVA_DAMAGE_INTERVAL?1:Math.floor(a/k.LAVA_DAMAGE_INTERVAL),0>=u.lava_protect_time_left()&&y.change_hp(-a),b=0)):b=0});"dungeon"==d.LEVEL_NAME&&(a=q.get_object_by_dupli_name("level_02_enviroment","lava"),x.apply_def(a),x.set_behavior(a,x.AB_FINISH_STOP),x.set_frame(a,0),x.stop(a),q.get_object_by_dupli_name("lava_death_controller","lava_death_controller"),
x.stop(a))}var x=b("animation"),e=b("controls"),q=b("scenes"),t=b("transform"),C=b("vec3"),D=b("sfx"),y=b("character"),k=b("game_config"),u=b("bonuses"),d=null,n={},l=new Float32Array(3);a.init=function(a,b){d=b;h(a);d.ROCK_EMPTIES&&F(a,d)};a.reset=function(){if("volcano"==d.LEVEL_NAME)for(var a=0;a<d.ROCK_EMPTIES.length;a++)for(var b=d.ROCK_EMPTIES[a],e=0;e<d.ROCK_NAMES.length;e++){var g=d.ROCK_NAMES[e],k=q.get_object_by_dupli_name(b,g);A(k);n[g]=0}};a.disable_environment=function(){if(d.ROCK_EMPTIES)for(var a=
0;a<d.ROCK_EMPTIES.length;a++)for(var b=d.ROCK_EMPTIES[a],h=0;h<d.ROCK_NAMES.length;h++){var g=d.MARK_NAMES[h],l=q.get_object_by_dupli_name(b,d.ROCK_NAMES[h]),g=q.get_object_by_dupli_name(b,g);e.remove_sensor_manifold(l);A(l);t.set_translation_v(g,k.DEFAULT_POS)}}});if(b4w.module_check("game_main"))throw"Failed to register module: game_main";
b4w.register("game_main",function(a,b){function F(a){var b=e.get_active_camera(),d=e.get_object_by_dupli_name("character","camera_target");x.append_semi_soft_cam(b,d,t.CAM_OFFSET,t.CAM_SOFTNESS);a=h.create_ray_sensor(d,t.CAM_OFFSET,[0,0,0],"VISUAL_BLOCKER",!0,!0,!1);h.create_sensor_manifold(d,"CAM_ADJUSTMENT",h.CT_TRIGGER,[a],null,function(a,c,e){x.remove(b);1==e?x.append_semi_soft_cam(b,d,[0,12,-9],t.CAM_SOFTNESS):x.append_semi_soft_cam(b,d,t.CAM_OFFSET,t.CAM_SOFTNESS)})}function A(){if(l.MUSIC_SPEAKERS){var a=
e.get_object_by_dupli_name("enviroment",l.MUSIC_INTRO_SPEAKER),b=e.get_object_by_dupli_name("enviroment",l.MUSIC_END_SPEAKER);a&&b&&(q.play_def(a),q.stop(b),a=q.get_duration(a)*q.get_playrate(a),h.create_sensor_manifold(null,"PLAYLIST",h.CT_SHOT,[h.create_timer_sensor(a)],null,function(a,b,c){h.remove_sensor_manifold(null,"PLAYLIST");if(!(0>=C.get_wrapper().hp)){a=[];b=l.MUSIC_SPEAKERS;for(c=0;c<b.length;c++){var d=e.get_object_by_dupli_name("enviroment",b[c]);a.push(d)}q.apply_playlist(a,0,!0)}}))}}
b("app");b("main");var h=b("controls"),x=b("constraints"),e=b("scenes");b("config");b("print");var q=b("sfx");b("transform");b("physics");b("vec3");b("quat");var t=b("game_config"),C=b("character");b("combat");var D=b("bonuses"),y=b("interface"),k=b("enemies"),u=b("obelisks"),d=b("gems"),n=b("environment"),l=null;new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(3);new Float32Array(4);new Float32Array(4);a.level_load_cb=function(a,e){l=b(e+"_config");C.init_wrapper(l,e);
var q=h.create_elapsed_sensor();D.init(q,l);k.init(q,l);u.init(q,l);d.init(l);n.init(q,l);A();C.setup_controls(q);F(q);y.init(function(){document.getElementById("replay").style.visibility="hidden";h.remove_sensor_manifold(null,"PLAYLIST");C.reset();d.reset();D.reset();k.reset();u.reset();n.reset();C.setup_controls(q);y.update_hp_bar();A()})}});if(b4w.module_check("intro_main"))throw"Failed to register module: intro_main";
b4w.register("intro_main",function(a,b){function F(a,b){b?(window.onresize=A,A(),f=a,l.enable_controls(a),preloader_bg.style.visibility="visible",h()?v.load(ba+"intro_LQ.json",x,n,!0):v.load(ba+"intro_HQ.json",x,n,!0)):m.log("b4w init failure")}function A(){l.resize_to_container()}function h(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||
navigator.userAgent.match(/Windows Phone/i)?!0:!1}function x(a){P=f.width/2;R=f.height/2;c.get_camera_angles(z.get_active_camera(),S);M.enqueue([["config",M.AT_JSON,"js/intro_config.json"]],e,null);f.addEventListener("mousemove",D,!1);f.addEventListener("mouseup",y,!1)}function e(a,b,c,d){b=a.buttons_info;c=g.create_elapsed_sensor();for(d=0;d<b.length;d++){var e=b[d],f=z.get_object_by_dupli_name_list(e.button_name.split("*"));if(f){var f=f.name,h=z.get_object_by_dupli_name_list(e.mouse_over_speaker.split("*"));
B.stop(h);var k=[],m=e.glow_obj_names;if("object"==typeof m)for(var n=0;n<m.length;n++){var p=z.get_object_by_dupli_name_list(m[n].split("*"));p&&k.push(p)}else k.push(z.get_object_by_dupli_name_list(m.split("*")));K[f]={glow_objs:k,speaker:h,level_name:e.level_name,material:e.material,value_node_name:e.value_node_name,glow_grow_time:e.glow_grow_time,min_glow_value:e.min_glow_value,max_glow_value:e.max_glow_value,glow_curr_value:e.min_glow_value,outline_grow_time:e.outline_grow_time,min_outline_value:e.min_outline_value,
max_outline_value:e.max_outline_value,outline_curr_value:e.min_outline_value,stop_playlist:e.stop_playlist_onclick}}}g.create_sensor_manifold(null,"GLOW",g.CT_CONTINUOUS,[c],null,t);g.create_sensor_manifold(null,"ROT_CAMERA",g.CT_CONTINUOUS,[c],null,C);q(a);(b=l.get_url_params())&&"lang"in b&&(c=z.get_object_by_dupli_name_list(a.language_obj.split("*")),console.log("LANG OBJ",c),d=1,"ru"==b.lang&&(d=0),w.set_nodemat_value(c,["stones_n_dolmens","language_switcher"],d));T=a.camera_rotation_fac;Q=a.environment_start_anim_delay;
X=a.environment_anim_length;Y=a.environment_energy_final;Z=a.environment_horizon_final;aa=a.environment_zenith_final}function q(a){I=z.get_object_by_dupli_name_list(a.intro_speaker.split("*"));N=z.get_object_by_dupli_name_list(a.end_speaker.split("*"));a=a.playlist_speakers;for(var b=0;b<a.length;b++){var c=z.get_object_by_dupli_name_list(a[b].split("*"));B.stop(c);H.push(c);B.mute(c,!1)}a=B.get_duration(I)*B.get_playrate(I);B.mute(I,!1);B.mute(N,!1);B.stop(N);B.play_def(I);g.create_sensor_manifold(null,
"PLAYLIST",g.CT_SHOT,[g.create_timer_sensor(a)],null,function(a,b,c){O||(B.stop(I),B.apply_playlist(H,0,!0))})}function t(a,b,c){a=g.get_sensor_value(a,b,0);for(var d in K){b=K[d];var e=b.glow_curr_value,f=b.min_glow_value,h=b.max_glow_value,k=a/b.glow_grow_time;c=b.outline_curr_value;var l=b.min_outline_value,m=b.max_outline_value,n=a/b.outline_grow_time;J&&d==J.name&&(e<h&&(b.glow_curr_value+=k),void 0!==c&&c<m&&(b.outline_curr_value+=n));J&&d==J.name||(e>f&&(b.glow_curr_value-=k),void 0!==c&&c>
l&&(b.outline_curr_value-=n));if(void 0!==e&&b.glow_curr_value!=e)for(e=0;e<b.glow_objs.length;e++)w.set_nodemat_value(b.glow_objs[e],[b.material,b.value_node_name],b.glow_curr_value);if(void 0!==c&&b.outline_curr_value!=c)for(e=0;e<b.glow_objs.length;e++)z.set_outline_intensity(b.glow_objs[e],b.outline_curr_value)}}function C(a,b,d){d=z.get_active_camera();c.is_target_camera(d)&&(g.get_sensor_value(a,b,0),a=f.width/2,b=f.height/2,c.get_camera_angles(d,ca),c.target_rotate(d,S[0]-(a-P)/f.width*T,S[1]-
(b-R)/f.height*T,!0,!0))}function D(a){a.preventDefault&&a.preventDefault();var b=a.clientX;a=a.clientY;var c=z.pick_object(b,a);c&&c!=J?(J=c,(c=K[c.name])&&c.speaker&&B.play_def(c.speaker)):!c&&J&&(J=null);P=b;R=a}function y(a){a.preventDefault&&a.preventDefault();(a=z.pick_object(a.clientX,a.clientY))&&K[a.name]&&(a=K[a.name],a.stop_playlist&&(k(),u()),a.level_name&&d(a.level_name))}function k(a){for(a=0;a<H.length;a++){var b=H[a];B.is_play(b)&&B.duck(b,0,1)}B.duck(I,0,1);setTimeout(function(){B.clear_playlist();
O=!0;B.play_def(N)},1E3)}function u(){var a=z.get_environment_colors(),b=a[0],c=a[1],d=a[2],e=0,f=0,h=[0,0,0],k=[0,0,0],l=function(){var a=(f-p.global_timeline())/X;if(0>=a)g.remove_sensor_manifold(null,"ANIMATE_ENV"),z.set_environment_colors(Y,Z,aa);else{var e=G.lerp(a,Y,b);E.lerp(Z,c,a,h);E.lerp(aa,d,a,k);z.set_environment_colors(e,h,k)}};setTimeout(function(){e=p.global_timeline();f=e+X;var a=g.create_elapsed_sensor();g.create_sensor_manifold(null,"ANIMATE_ENV",g.CT_CONTINUOUS,[a],null,l)},1E3*
Q)}function d(a){var b=ba+a+".json";f.removeEventListener("mouseup",y);f.removeEventListener("touchscreen",y);f.removeEventListener("mousemove",D);v.unload();preloader_bg.style.visibility="visible";v.load(b,function(b){L.level_load_cb(b,a)},n,!0)}function n(a){var b=document.getElementById("prelod_dynamic_path"),c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&(document.getElementById("preloader_bg").style.visibility="hidden")}var l=b("app");b("camera_anim");var c=b("camera"),
p=b("main"),v=b("data"),g=b("controls");b("constraints");var z=b("scenes"),r=b("config"),m=b("print"),B=b("sfx"),M=b("assets"),w=b("objects");b("container");var G=b("util"),E=b("vec3");b("quat");b("game_config");var L=b("game_main"),J=null,K={},O=!1,I=null,H=[],N=null,f=null,P=0,R=0,S=new Float32Array(2),T=0,Q,X,Y,Z,aa,ca=new Float32Array(2),ba=r.get_std_assets_path()+"petigors_tale/";a.init=function(){var a=h();l.init({canvas_container_id:"canvas3d",callback:F,physics_enabled:!0,quality:a?r.P_LOW:
r.P_HIGH,console_verbose:!0,show_fps:!0,alpha:!1,physics_use_workers:!a})}});b4w.require("intro_main").init();
