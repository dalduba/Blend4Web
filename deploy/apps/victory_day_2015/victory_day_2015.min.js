b4w.register("victory_day_2015_main",function(bb,k){function cb(a,c){if(c){r=a;q.enable_controls();Ca.pause();db();var b=eb.get_std_assets_path();fb.load(b+"victory_day_2015/main_scene.json",gb,hb);Da();window.addEventListener("resize",Da)}else console.log("b4w init failure")}function W(a){if(z){var c=X.get_coords_x(a);a=X.get_coords_y(a);Ea(c,a);Fa(c,a)}}function P(){ja&&(ja=!1,ka?(z=null,ib()):(G.pop(),G.pop(),l.remove_object(z),z=null,--t))}function ib(){var a=G[G.length-2],c=G[G.length-1],b=m.get_tsr(a,
h.create()),d=m.get_tsr(c,h.create()),e=h.transform_vec3(Ga,d,d);H.animate(0,1,500,function(d){var l=h.interpolate(b,e,N.smooth_step(d),h.create());m.set_tsr(a,l);1==d&&jb(a,c)})}function jb(a,c){var b=m.get_tsr(a,h.create()),d=m.get_tsr(c,h.create());Math.round(Math.random())?p.play_def(Ha):p.play_def(Ia);H.animate(0,1,500,function(e){var A=h.interpolate(b,d,N.smooth_step(e),h.create());m.set_tsr(a,A);1==e&&(r.addEventListener("mousedown",D),r.addEventListener("touchstart",D),S.append_stiff(a,c,
w.set(0,0,0,Y)),O.set_nodemat_value(B,["control_box","Value"],1))})}function D(a){a.preventDefault&&a.preventDefault();var c=X.get_coords_x(a);a=X.get_coords_y(a);var b=l.pick_object(c,a);if(b)switch(l.get_object_name(b)){case "rockets_box*rockets_box":if(16!=t){t+=1;z=b=O.copy(Ja,"rocket_"+t);G.push(b);var d="";10>t&&(d="0");la=d=l.get_object_by_dupli_name("bm_13","rail_"+d+t);G.push(d);l.append_object(b);Ea(c,a);Fa(c,a);ja=!0}break;case "control_box*control_box_button":Z=2,kb()}}function kb(){t&&
(r.removeEventListener("mousedown",D),r.removeEventListener("touchstart",D),p.stop(ma),p.play_def(ma),b.apply(n,"press_button_Action"),b.set_behavior(n,b.AB_FINISH_STOP),b.play(n),b.set_speed(E,-1),b.play(E,function(){b.apply(g,"bm_13_Armature_rotate_-37_Action");b.set_frame(g,b.get_anim_start_frame(g));b.set_behavior(g,b.AB_FINISH_STOP);b.play(g,lb)}))}function lb(){var a=b.apply,c=b.play,f=b.set_behavior;a(e,T);b.set_frame(e,b.get_anim_start_frame(g));f(e,b.AB_FINISH_STOP);c(e,mb);a(B,"hide_control_box_Action");
a(n,"hide_control_box_Action");f(B,b.AB_FINISH_STOP);f(n,b.AB_FINISH_STOP);c(B);c(n);p.stop(U)}function mb(){for(var a=1;a<=t;a++)nb(a)}function nb(a){var c=l.append_object,f=S.append_stiff,d=b.apply,M=O.copy,A=b.play,k=S.remove,g=l.remove_object,y=b.set_behavior,v=l.show_object,aa=b.set_frame,ba=b.get_anim_start_frame,u="";10>a&&(u="0");var q=l.get_object_by_name("rocket_"+a),z=l.get_object_by_dupli_name("bm_13","rail_"+u+a);k(q);var n=M(Ka,"rocket_flash_"+a),F=M(La,"rocket_plume_"+a),x=M(na,"rocket_start_smoke_"+
a),I=M(oa,"settling_smoke_"+a);H.set_timeout(function(){c(n);c(F);c(x);c(I);v(x);v(I);d(n,"rocket_flash_Shader_NodetreeAction");d(F,"rocket_plume_start_Shader_NodetreeAction");d(x,"rocket_start_smoke_Shader_NodetreeAction");d(x,"rocket_start_smoke_finalscale",b.SLOT_1);d(I,"settling smoke_Shader_NodetreeAction");y(F,b.AB_FINISH_STOP);y(n,b.AB_FINISH_STOP);y(x,b.AB_FINISH_STOP);y(x,b.AB_FINISH_STOP,b.SLOT_1);y(I,b.AB_FINISH_STOP);y(J,b.AB_FINISH_STOP);y(K,b.AB_FINISH_STOP);f(n,q,pa);f(F,q,pa);f(x,
z,ob);k(x);f(I,q,pa);A(n);A(x,function(){g(x)});var M=h.identity(h.create()),u=h.identity(h.create());m.get_tsr(x,M);m.get_tsr(x,u);H.animate(0,.5,1E3,function(a){u[1]=M[1]-a;m.set_tsr(x,u)});H.set_timeout(function(){A(x,null,b.SLOT_1)},b.frame_to_sec(9));A(I,function(){k(I);g(I)});A(F,function(){d(F,"rocket_plume_loop__Shader_NodetreeAction");y(F,b.AB_CYCLIC);A(F)});H.set_timeout(function(){k(I)},100);p.play_def(qa);var w=m.get_tsr(q,h.identity(h.create())),B=h.create();h.copy(w,B);var E=h.transform_vec3(Ma,
w,B);if(ra?0:a==(0>=t?1==t?1:t-1:t-0))ra=!0,d(J,"residual_smoke_Armature_Action"),d(K,"residual_smoke_Shader_NodetreeAction"),d(C,"rocket_smoke_Shader_NodetreeAction"),d(C,"rocket_smoke_finalscale",b.SLOT_1),aa(J,ba(J)),aa(K,ba(K)),aa(C,ba(C)),aa(C,ba(C),b.SLOT_1),y(J,b.AB_FINISH_STOP),y(K,b.AB_FINISH_STOP),y(C,b.AB_FINISH_STOP),y(C,b.AB_FINISH_STOP,b.SLOT_1),A(C),A(C,null,b.SLOT_1),H.set_timeout(function(){v(K);A(J);b.play(K,function(){ra=!1;m.set_tsr(e,Na);var a=m.get_rotation(e,sa),a=Q.rotateX(a,
Math.PI,Oa);m.set_rotation_v(e,a);a=l.hide_object;a(ca);a(da);a(ta);b.apply(R,"9may_atlas_Shader_NodetreeAction");b.set_frame(R,b.get_anim_start_frame(R));b.set_behavior(R,b.AB_FINISH_STOP);p.stop(ea);p.play_def(ea);fa=0;for(a=1;a<=t;a++)pb(a)})},500);1==a&&ua.set_light_params(L,{light_energy:20});H.animate(0,1,2E3,function(c){var b=h.interpolate(w,E,N.smooth_step(c),h.identity(h.create()));m.set_tsr(q,b);m.set_translation(L,b[0],b[1]+8,b[2]);1==c&&(k(n),k(F),g(q),g(n),g(F),a==t&&(G=[],p.stop(qa),
r.addEventListener("mousedown",D),r.addEventListener("touchstart",D)))})},250*a)}function Ea(a,c){var b=Pa.calc_ray(e,a,c,Y),d=m.get_translation(e,Qa),b=w.scale(b,3,va),d=w.add(d,b,Ra);d[1]=N.clamp(d[1],.5,3);m.set_translation_v(z,d)}function Fa(a,b){var f=m.get_translation(z,Y),d=m.get_rotation(z,sa),h=m.get_translation(la,Qa),k=m.get_rotation(la,Oa),l=Pa.project_point(e,h,va),g=a-l[0],l=b-l[1],g=Math.sqrt(g*g+l*l);400>g?ka=!0:(ka=!1,g=400);l=N.quat_to_dir(d,N.AXIS_MY,va);f=w.subtract(f,h,Ra);w.normalize(f,
f);f=Q.rotationTo(l,f,qb);Q.multiply(f,d,d);Q.normalize(d,d);d=Q.slerp(k,d,g/400,rb);m.set_rotation_v(z,d)}function wa(){var a=document.querySelector("#content"),b=document.querySelector("#info_container"),f=document.querySelector("#footer");ga>window.innerHeight+10?(ga-50>=window.innerHeight&&(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),440>window.innerHeight?(a.style.display="none",f.style.backgroundImage="",a.style.backgroundImage=
""):(ga-50>=window.innerHeight&&(f.style.backgroundImage="url(icons/scroll_img.png)",a.style.backgroundImage="url(icons/scroll_fade_img.png)"),a.style.display="",a.style.height=b.offsetHeight-200-175+"px"),380>window.innerWidth&&(a.style.height=parseInt(a.style.height)+70+"px")):(a.style.height="",f.style.backgroundImage="",a.style.backgroundImage="")}function gb(){var a=q.get_url_params();if(a&&"lang"in a){var c="ru";"ru"==a.lang&&(c="en");var a=document.querySelector("#social_buttons."+c),f=document.querySelector("#info."+
c),c=document.querySelector("#run_button."+c);a.parentNode.removeChild(a);f.parentNode.removeChild(f);c.parentNode.removeChild(c)}V=document.querySelector("#replay");xa=V.querySelector("#replay_circle");u=document.querySelector("#info_container");ha=document.querySelector("#blend4web_logo");ia=document.querySelector("#social_buttons");c=l.get_object_by_dupli_name;a=l.get_object_by_name;e=l.get_active_camera();R=c("9_may_logo","planes");ca=c("firework","firework_1");da=c("firework","firework_2_1");
ta=c("firework","firework_2_2");Ja=c("rocket","rocket");Sa=a("Empty_camera_position_2");U=c("red_square","noise_spk");ma=c("control_box","button_spk");Ha=c("bm_13","load_spk");Ia=c("bm_13","load_spk_2");g=c("bm_13","bm_13_Armature");ea=c("bg","fireworks_spk");B=c("control_box","control_box");n=c("control_box","control_box_button");qa=c("bm_13","shot_spk");Ka=c("rocket_plume_flash","rocket_flash");La=c("rocket_plume_flash","rocket_plume");na=c("rocket_start_smoke","rocket_start_smoke");J=c("residual_smoke",
"residual_smoke_Armature");K=l.get_object_children(J)[0];oa=c("settling smoke","settling smoke");C=c("rocket_smoke","rocket_smoke");L=a("rocket_Point_1");Ta=a("bm_13");E=c("rockets_box","rockets_box_Armature");Ua=ua.get_light_params(L);c=m.get_tsr;a=w.set;c(e,ya);c(ca,za);c(da,Aa);Aa[3]=1;w.subtract(Aa,za,Ba);c(Sa,Na);a(0,-1.1,0,Ga);a(0,85,0,Ma);c(L,Va);c=l.get_object_by_name("control_box");f=h.multiply(h.invert(ya,h.create()),m.get_tsr(c),h.create());a=Math.abs(f[1]);f=h.get_quat_view(f);S.append_stiff_viewport(c,
e,{right:0,bottom:0,distance:a,rotation:f});S.append_track(L,Ta);Wa();b.apply(e,T);c=b.get_anim_start_frame(e);a=b.get_anim_length(e);b.set_frame(e,c+a-.001);window.addEventListener("resize",wa)}function Wa(){T=window.innerWidth>window.innerHeight?"Camera_wide screen_Action":"Camera_narrow_screen_Action";e&&1==Z&&!b.is_play(e)&&b.apply(e,T)}function pb(a){var c=O.copy,f=l.show_object,d=l.append_object,h=l.remove_object,e=b.apply,g=b.play,k=b.SLOT_1,r=m.set_tsr,q=c(ca,"firework_"+a),p=c(da,"firework_"+
a+t+1),n=c(ta,"firework_"+a+t+2);f(q);f(p);f(n);var c=Math.floor(Math.random()*Xa.length),c=Xa[c],f=.4*-Math.random()+-.2,u=2*Math.random()+-1,v=.3*-Math.random()+0;O.set_nodemat_rgb(p,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);O.set_nodemat_rgb(n,["firework_2","RGB"],c[0]/255,c[1]/255,c[2]/255);c=Ya(za,f,u,0,v,sb);f=Ya(c,Ba[0],Ba[1],.03*a,0,tb);r(q,c);r(p,f);r(n,f);var w=null;t==a&&(w=ub);H.set_timeout(function(){d(q);d(p);d(n);e(q,"firework_1_Shader_NodetreeAction");e(p,"firework_2_Action");
e(p,"firework_2_Shader_NodetreeAction",k);e(n,"firework_2_Action");e(n,"firework_2_Shader_NodetreeAction",k);g(q,function(){h(q)});g(n);g(p,function(){h(p)});g(n,function(){h(n);w&&w()},k)},fa);fa+=500*(.5+Math.random())}function ub(){p.stop(ea);b.play(R,vb)}function vb(){xa.addEventListener("click",Za);var a=V.style;a.opacity=0;a.display="block";a=ha.style;a.opacity=0;a.display="block";a=ia.style;a.opacity=0;a.display="block";q.css_animate(V,"opacity",0,1,1E3,"","",function(){q.css_animate(ha,"opacity",
0,1,300);q.css_animate(ia,"opacity",0,1,500)});b.apply(g,"bm_13_Armature_rotate_-20_Action");b.set_behavior(g,b.AB_FINISH_STOP);b.set_frame(g,b.get_anim_start_frame(g))}function Za(){var a=b.set_frame,c=b.get_anim_start_frame;ha.style.display="";ia.style.display="";V.style.display="";O.set_nodemat_value(B,["control_box","Value"],0);a(e,c(e));xa.removeEventListener("click",Za);t=0;m.set_tsr(e,ya);m.set_tsr(L,Va);ua.set_light_params(L,Ua);b.apply(e,T);a(B,c(B));a(n,c(n));p.play_def(U);Z=1;$a()}function Ya(a,
b,f,d,e,g){h.identity(g);e=Q.setAxisAngle(N.AXIS_Z,e,sa);b=w.set(b,f,d,Y);h.set_trans(b,g);h.set_quat(e,g);h.multiply(a,g,g);return g}function Da(){q.resize_to_container();Wa()}function hb(a){var b=v.querySelector("#preloader_line_left"),f=v.querySelector("#preloader_line_right"),d=v.querySelector("#percentage");100==a?wb():(40>=a?b.style.width=2*a+"%":40<a&&60>a?b.style.width="100%":60<a&&(b.style.width="100%",f.style.width=2*(a-50)+"%"),d.innerHTML=a)}function db(){v=document.querySelector("#preloader_container");
var a=v.querySelector("#bg_image_container"),b=v.querySelector("#bg_fade_container"),f=v.querySelector("#sun_container"),d=v.querySelector("#preloader"),e=q.css_animate;e(b,"opacity",0,.6,300);e(v,"opacity",0,1,300,"","",function(){e(a,"opacity",0,1,300,"","",function(){e(f,"opacity",0,1,300,"","",function(){e(d,"opacity",0,1,300,"","",function(){Ca.resume();main_canvas_container.style.visibility="visible"})})})})}function wb(){xb();q.css_animate(v,"opacity",1,0,300,"","",function(){v.parentNode.removeChild(v)})}
function xb(){var a=u.querySelector("#close_info_but"),b=u.querySelector("#run_button"),e=u.querySelector("#info"),d=u.querySelector("#sound_cont");a.addEventListener("click",ab);b.addEventListener("click",ab);d.addEventListener("click",yb);u.style.display="block";e.style.display="block";b.style.display="block";document.querySelector("#content");ga=u.scrollHeight;wa()}function yb(){var a=u.querySelector("#sound_cont");"active"==a.className?(a.className="",p.mute(null,!0)):(a.className="active",p.mute(null,
!1))}function ab(){var a=document.querySelector("#background_color");window.removeEventListener("resize",wa);l.hide_object(na);l.hide_object(oa);u.parentNode.removeChild(u);a.parentNode.removeChild(a);a=l.get_object_by_dupli_name("red_square","clock_spk");p.stop(a);p.stop(U);p.play_def(a);p.play_def(U);b.set_speed(e,-1);b.set_behavior(e,b.AB_FINISH_STOP);b.play(e,$a)}function $a(){b.apply(E,"opening_rockets_box_Action");b.set_frame(E,b.get_anim_start_frame(E));b.set_behavior(E,b.AB_FINISH_STOP);b.play(E,
zb)}function zb(){b.apply(g,"bm_13_Armature_rotate_-20_Action");b.set_frame(g,b.get_anim_start_frame(g));b.set_behavior(g,b.AB_FINISH_STOP);b.play(g,Ab)}function Ab(){r.removeEventListener("mousedown",D);r.removeEventListener("touchstart",D);r.removeEventListener("mousemove",W);r.removeEventListener("touchmove",W);r.removeEventListener("mouseup",P);r.removeEventListener("touchend",P);document.removeEventListener("mouseout",P);r.addEventListener("mousedown",D);r.addEventListener("touchstart",D);r.addEventListener("mousemove",
W);r.addEventListener("touchmove",W);r.addEventListener("mouseup",P);r.addEventListener("touchend",P);document.addEventListener("mouseout",P);Z=1}var b=k("animation"),q=k("app"),Pa=k("camera"),eb=k("config"),S=k("constraints");k("controls");var fb=k("data"),ua=k("lights"),Ca=k("main"),X=k("mouse"),O=k("objects"),l=k("scenes"),p=k("sfx"),H=k("time"),m=k("transform"),h=k("tsr"),N=k("util"),Q=k("quat"),w=k("vec3"),G=[],Xa=[[255,255,0],[255,0,148],[0,255,0],[0,0,255],[161,0,255],[255,255,255],[94,255,
255]],ya=new Float32Array(8),Na=new Float32Array(8),za=new Float32Array(8),Aa=new Float32Array(8),Va=new Float32Array(8),sb=new Float32Array(8),tb=new Float32Array(8),Ba=new Float32Array(3),Ga=new Float32Array(3),Ma=new Float32Array(3),Y=new Float32Array(3),Qa=new Float32Array(3),va=new Float32Array(3),Ra=new Float32Array(3),pa=new Float32Array([0,0,0]),ob=new Float32Array([0,0,1]);new Float32Array([0,-1.2,0]);var qb=new Float32Array(4),sa=new Float32Array(4),Oa=new Float32Array(4),rb=new Float32Array(4),
R=null,Ta=null,g=null,ma=null,r=null,e=null,Sa=null,B=null,n=null,z=null,la=null,ca=null,da=null,ta=null,ea=null,L=null,Ha=null,Ia=null,U=null,Ja=null,J=null,K=null,Ka=null,La=null,C=null,na=null,E=null,oa=null,qa=null,ha=null,u=null,V=null,xa=null,ia=null,ga=0,v=null,ka=!1,ja=!1,ra=!1,T="",Z=0,fa=0,t=0,Ua=null;bb.init=function(){q.init({canvas_container_id:"main_canvas_container",callback:cb,alpha:!1,report_init_failure:!0,console_verbose:!0,show_fps:!1})}});b4w.require("victory_day_2015_main").init();
